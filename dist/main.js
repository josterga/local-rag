(()=>{"use strict";var e={d:(t,n)=>{for(var i in n)e.o(n,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:n[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{default:()=>a});const n=require("obsidian");var i=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{d(i.next(e))}catch(e){r(e)}}function a(e){try{d(i.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,a)}d((i=i.apply(e,t||[])).next())})};const o="rag-chat-view",r="http://localhost:11434",s="mxbai-embed-large";class a extends n.Plugin{onload(){return i(this,void 0,void 0,function*(){this.registerView(o,e=>new l(e,this)),this.addCommand({id:"open-rag-chat",name:"Open RAG Chat",callback:()=>this.activateView()}),this.app.workspace.onLayoutReady(()=>{this.activateView()})})}onunload(){this.app.workspace.detachLeavesOfType(o)}activateView(){return i(this,void 0,void 0,function*(){var e;let t=null!==(e=this.app.workspace.getLeavesOfType(o)[0])&&void 0!==e?e:null;t||(t=this.app.workspace.getLeaf(!1)),t?(yield t.setViewState({type:o,active:!0}),this.app.workspace.revealLeaf(t)):new n.Notice("Could not open RAG Chat panel.")})}searchNotes(e){return i(this,void 0,void 0,function*(){const t=new Set(["what","are","the","is","of","on","to","in","and","or","a","an","for","this","that","with"]),n=e.toLowerCase().split(/\W+/).filter(e=>e&&!t.has(e)),i=this.app.vault.getMarkdownFiles(),o=[];for(const e of i){const t=yield this.app.vault.read(e),i=t.toLowerCase();if(n.some(e=>i.includes(e))){let r=-1;for(const e of n){const t=i.indexOf(e);-1!==t&&(-1===r||t<r)&&(r=t)}const s=t.slice(Math.max(0,r-50),r+150).replace(/\n+/g," ");o.push({file:e,snippet:s})}}return o})}}function d(e){const t=e.indexOf("{"),n=e.lastIndexOf("}");if(-1===t||-1===n)throw new Error("Invalid response: JSON object not found.");const i=e.slice(t,n+1);try{return JSON.parse(i)}catch(e){throw console.error("Failed to parse Ollama JSON extract:",i),new Error("Ollama response could not be parsed as JSON.")}}class l extends n.ItemView{constructor(e,t){super(e),this.isProcessing=!1,this.plugin=t}getViewType(){return o}getDisplayText(){return"RAG Chat"}getIcon(){return"message-square"}onOpen(){return i(this,void 0,void 0,function*(){const e=this.containerEl;e.empty(),e.setAttr("style","height: 100%; width: 100%; min-width: 200px; display: flex; flex-direction: column; overflow: hidden;");const t=e.createDiv("rag-chat-outer");t.setAttr("style","display: flex; flex-direction: column; flex: 1 1 0; height: 100%; width: 100%; background: var(--background-primary);"),this.chatContainer=t.createDiv("rag-chat-messages"),this.chatContainer.setAttr("style","flex: 1 1 auto; overflow-y: auto; border: 1px solid var(--divider-color); padding: 16px 16px 80px 16px; box-sizing: border-box; border-radius: 8px 8px 0 0;background-color: var(--background-modifier-hover); font-size: 15px; min-height: 0; width: 100%;");const n=t.createDiv();n.setAttr("style","display: flex; flex-shrink: 0; gap: 8px; align-items: flex-end;width: 100%; box-sizing: border-box; padding: 12px; background: var(--background-primary); border-top: 1px solid var(--divider-color);transform: translateY(-5%);"),this.inputEl=n.createEl("textarea",{placeholder:"Ask a question..."}),this.inputEl.setAttr("rows","1"),this.inputEl.setAttr("style","flex: 1 1 0; min-width: 0; resize: none; max-height: 120px;padding: 10px 12px; font-size: 15px; border-radius: 6px;border: 1px solid var(--interactive-accent); overflow-y: auto;font-family: var(--font-monospace); color: var(--text-normal); box-sizing: border-box;"),this.inputEl.addEventListener("input",()=>{this.inputEl.style.height="auto",this.inputEl.style.height=Math.min(this.inputEl.scrollHeight,120)+"px",this.inputEl.style.overflowY=this.inputEl.scrollHeight>120?"auto":"hidden"}),this.inputEl.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.handleSubmit())});const i=n.createEl("button",{text:"Send"});i.setAttr("style","\n      flex-shrink: 0;\n      height: 100%;\n      padding: 0px 18px;\n      border-radius: 6px;\n      border: none;\n      background-color: var(--interactive-accent);\n      color: var(--text-on-interactive-accent);\n      font-weight: 600;\n      font-size: 15px;\n      cursor: pointer;\n      transition: background-color 0.2s;\n      user-select: none;\n      max-height: 44px;\n      min-width: 64px;\n      white-space: nowrap;\n      overflow: hidden;\n      text-overflow: ellipsis;\n    "),i.onmouseenter=()=>{i.style.backgroundColor="var(--interactive-accent-pressed)"},i.onmouseleave=()=>{i.style.backgroundColor="var(--interactive-accent)"},i.onclick=()=>this.handleSubmit()})}addMessage(e,t){const n=this.chatContainer.createDiv();n.setAttr("style",`margin-bottom: 14px; padding: 14px 20px; border-radius: 10px; white-space: pre-wrap; word-break: break-word; user-select: text;width: 100%; box-sizing: border-box; font-size: 15px; line-height: 1.45;color: var(--text-normal); background-color: ${"user"===e?"var(--background-primary)":"var(--background-secondary-alt)"}; border: 1px solid var(--divider-color);align-self: ${"user"===e?"flex-end":"flex-start"};`),n.createSpan({text:t}),this.chatContainer.scrollTop=this.chatContainer.scrollHeight}approximateTokenCount(e){return e.trim().split(/\s+/).length}buildContextWithTokenLimit(e){let t=0;const n=[];for(const i of e){const e=this.approximateTokenCount(i.snippet)+20;if(t+e>700)break;t+=e,n.push(`File: ${i.file.basename}\n${i.snippet}`)}return n.join("\n\n")}handleSubmit(){return i(this,void 0,void 0,function*(){var e,t;if(this.isProcessing)return;const n=this.inputEl.value.trim();if(n){this.addMessage("user",n),this.inputEl.value="",this.inputEl.style.height="auto",this.isProcessing=!0;try{const t=yield this.plugin.searchNotes(n);if(0===t.length)return this.addMessage("rag","no matching notes found."),void(this.isProcessing=!1);this.addMessage("rag","generating response...");const o=yield function(e){return i(this,void 0,void 0,function*(){var t;const n=yield fetch(`${r}/api/embed`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:s,input:e})}),i=d(yield n.text());return i.embedding||(null===(t=i.embeddings)||void 0===t?void 0:t[0])})}(n),a=t.map(e=>e.snippet),l=yield function(e){return i(this,void 0,void 0,function*(){const t=yield fetch(`${r}/api/embed`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:s,input:e})}),n=d(yield t.text());if(!Array.isArray(n.embeddings))throw new Error("Expected 'embeddings' to be an array.");return n.embeddings})}(a),c=t.map((e,t)=>{return Object.assign(Object.assign({},e),{sim:(n=o,i=l[t],n.reduce((e,t,n)=>e+t*i[n],0)/(Math.sqrt(n.reduce((e,t)=>e+t*t,0))*Math.sqrt(i.reduce((e,t)=>e+t*t,0))+1e-8))});var n,i}).sort((e,t)=>t.sim-e.sim),h=this.buildContextWithTokenLimit(c),p=yield function(e,t){return i(this,void 0,void 0,function*(){var n;const i=yield fetch(`${r}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"llama3",stream:!1,messages:[{role:"system",content:"You are a helpful assistant for an Obsidian vault. Only answer using the context provided."},{role:"user",content:`Context:\n${e}\n\nQuery: ${t}`}]})}),o=d(yield i.text());return(null===(n=o.message)||void 0===n?void 0:n.content)||o.response||"[no response]"})}(h,n);null===(e=this.chatContainer.lastChild)||void 0===e||e.remove(),this.addMessage("rag",p.trim())}catch(e){null===(t=this.chatContainer.lastChild)||void 0===t||t.remove(),this.addMessage("rag",`‚ùå Error: ${String(e.message||e)}`)}finally{this.isProcessing=!1}}})}onClose(){return i(this,void 0,void 0,function*(){})}}var c=exports;for(var h in t)c[h]=t[h];t.__esModule&&Object.defineProperty(c,"__esModule",{value:!0})})();