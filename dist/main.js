(()=>{"use strict";var e={d:(t,n)=>{for(var i in n)e.o(n,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:n[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{default:()=>a});const n=require("obsidian");var i=function(e,t,n,i){return new(n||(n=Promise))(function(o,s){function r(e){try{d(i.next(e))}catch(e){s(e)}}function a(e){try{d(i.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(r,a)}d((i=i.apply(e,t||[])).next())})};const o="rag-chat-view",s="http://localhost:11434",r="mxbai-embed-large";class a extends n.Plugin{onload(){return i(this,void 0,void 0,function*(){this.registerView(o,e=>new l(e,this)),this.addCommand({id:"open-rag-chat",name:"Open RAG Chat",callback:()=>this.activateView()}),this.app.workspace.onLayoutReady(()=>{this.activateView()})})}onunload(){this.app.workspace.detachLeavesOfType(o)}activateView(){return i(this,void 0,void 0,function*(){var e;let t=null!==(e=this.app.workspace.getLeavesOfType(o)[0])&&void 0!==e?e:null;t||(t=this.app.workspace.getRightLeaf(!0)),t?(yield t.setViewState({type:o,active:!0}),this.app.workspace.revealLeaf(t)):new n.Notice("Could not open RAG Chat panel.")})}searchNotes(e){return i(this,void 0,void 0,function*(){const t=new Set(["what","are","the","is","of","on","to","in","and","or","a","an","for","this","that","with"]),n=e.toLowerCase().split(/\W+/).filter(e=>e&&!t.has(e));console.log("Filtered keywords:",n);const i=this.app.vault.getMarkdownFiles(),o=[];for(const e of i){const t=yield this.app.vault.read(e),i=t.toLowerCase();if(n.some(e=>i.includes(e))){let s=-1;for(const e of n){const t=i.indexOf(e);-1!==t&&(-1===s||t<s)&&(s=t)}const r=t.slice(Math.max(0,s-50),s+150).replace(/\n+/g," ");o.push({file:e,snippet:r})}}return o})}}function d(e){const t=e.indexOf("{"),n=e.lastIndexOf("}");if(-1===t||-1===n)throw new Error("Invalid response: JSON object not found.");const i=e.slice(t,n+1);try{return JSON.parse(i)}catch(e){throw console.error("Failed to parse Ollama JSON extract:",i),new Error("Ollama response could not be parsed as JSON.")}}class l extends n.ItemView{constructor(e,t){super(e),this.isProcessing=!1,this.plugin=t}getViewType(){return o}getDisplayText(){return"RAG Chat"}getIcon(){return"message-square"}onOpen(){return i(this,void 0,void 0,function*(){const e=this.containerEl;e.empty(),e.createEl("h3",{text:"local-rag"}),this.chatContainer=e.createDiv("rag-chat-messages"),this.chatContainer.setAttr("style","overflow-y:auto;height:320px;border:1px solid var(--divider-color);padding:10px;border-radius:6px;margin-bottom:8px;");const t=e.createDiv();t.setAttr("style","display:flex;gap:8px;"),this.inputEl=t.createEl("input",{type:"text",placeholder:"Ask a question..."}),this.inputEl.setAttr("style","flex:1;padding:6px;");const n=t.createEl("button",{text:"Send"});n.setAttr("style","padding:6px 12px;"),n.onclick=()=>this.handleSubmit(),this.inputEl.addEventListener("keydown",e=>{"Enter"===e.key&&this.handleSubmit()})})}addMessage(e,t){const n=this.chatContainer.createDiv();n.setAttr("style",`margin-bottom:10px;padding:9px;border-radius:6px;background-color:${"user"===e?"var(--interactive-accent)":"var(--background-secondary-alt)"};color:var(--text-normal);white-space:pre-wrap;`),n.createSpan({text:t}),this.chatContainer.scrollTop=this.chatContainer.scrollHeight}handleSubmit(){return i(this,void 0,void 0,function*(){var e,t;if(this.isProcessing)return;const n=this.inputEl.value.trim();if(n){this.addMessage("user",n),this.inputEl.value="",this.isProcessing=!0,console.log("Query sent to searchNotes:",n);try{const t=yield this.plugin.searchNotes(n);if(0===t.length)return void this.addMessage("rag","üßê No matching notes found.");this.addMessage("rag","üß† Embedding & generating response...");const o=yield function(e){return i(this,void 0,void 0,function*(){var t;const n=yield fetch(`${s}/api/embed`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:r,input:e})}),i=d(yield n.text());return i.embedding||(null===(t=i.embeddings)||void 0===t?void 0:t[0])})}(n),a=t.map(e=>e.snippet),l=yield function(e){return i(this,void 0,void 0,function*(){const t=yield fetch(`${s}/api/embed`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:r,input:e})}),n=d(yield t.text());if(!Array.isArray(n.embeddings))throw new Error("Expected 'embeddings' to be an array.");return n.embeddings})}(a),c=t.map((e,t)=>{return Object.assign(Object.assign({},e),{sim:(n=o,i=l[t],n.reduce((e,t,n)=>e+t*i[n],0)/(Math.sqrt(n.reduce((e,t)=>e+t*t,0))*Math.sqrt(i.reduce((e,t)=>e+t*t,0))+1e-8))});var n,i}).sort((e,t)=>t.sim-e.sim).slice(0,3).map(e=>`File: ${e.file.basename}\n${e.snippet}`).join("\n\n"),p=yield function(e,t){return i(this,void 0,void 0,function*(){var n;const i=yield fetch(`${s}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"llama3",stream:!1,messages:[{role:"system",content:"You are a helpful assistant for an Obsidian vault. Only answer using the context provided."},{role:"user",content:`Context:\n${e}\n\nQuery: ${t}`}]})}),o=d(yield i.text());return(null===(n=o.message)||void 0===n?void 0:n.content)||o.response||"[no response]"})}(c,n);null===(e=this.chatContainer.lastChild)||void 0===e||e.remove(),this.addMessage("rag",p.trim())}catch(e){null===(t=this.chatContainer.lastChild)||void 0===t||t.remove(),this.addMessage("rag",`‚ùå Error: ${String(e.message||e)}`)}finally{this.isProcessing=!1}}})}onClose(){return i(this,void 0,void 0,function*(){})}}var c=exports;for(var p in t)c[p]=t[p];t.__esModule&&Object.defineProperty(c,"__esModule",{value:!0})})();